import io
from telethon.tl.types import Message
from hikka import loader

@loader.tds
class SDPicsMod(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏—Ö—Å—è –º–µ–¥–∏–∞."""

    strings = {
        "name": "SDPics",
        "description": "–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏—Ö—Å—è –º–µ–¥–∏–∞.",
        "usage": "üö´ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–µ–µ—Å—è –º–µ–¥–∏–∞.",
    }

    async def scmd(self, message: Message):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏—Ö—Å—è –º–µ–¥–∏–∞."""

        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª —Å–¥–µ–ª–∞–Ω –æ—Ç–≤–µ—Ç
        reply = await message.get_reply_message()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ–¥–∏–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ–Ω–æ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–µ–µ—Å—è (–∏–º–µ–µ—Ç ttl_seconds)
        if not self._is_valid_media(reply):
            return

        # –°–∫–∞—á–∏–≤–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ–¥–∏–∞
        await self._save_media(reply)

        # –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª–µ–¥–æ–≤
        await message.delete()

    def _is_valid_media(self, reply: Message) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–µ–¥–∏–∞ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏–º—Å—è."""
        if not reply or not reply.media:
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ–¥–∏–∞ –∏–º–µ–µ—Ç ttl_seconds –∏ –æ–Ω–æ –±–æ–ª—å—à–µ 0
        return hasattr(reply.media, 'ttl_seconds') and reply.media.ttl_seconds > 0

    async def _save_media(self, reply: Message):
        """–°–∫–∞—á–∏–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ–¥–∏–∞ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è."""
        try:
            # –°–∫–∞—á–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –≤ –ø–∞–º—è—Ç—å
            file = io.BytesIO(await reply.download_media(bytes))
            file.name = reply.file.name  # –ò–º—è —Ñ–∞–π–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —Å–µ–±–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            await self._client.send_file("me", file, silent=True)

            # –£–¥–∞–ª—è–µ–º –º–µ–¥–∏–∞ –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –æ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å–ª–µ–¥–æ–≤
            await reply.delete()

        except Exception:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
