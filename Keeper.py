__version__ = (1, 4, 8, 8)

#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚£∑‚£∂‚£§‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚¢†‚£§‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ª‚£ß‚†à‚†â‚†ª‚£∑‚£§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†π‚£ø‚°ü‚†ª‚¢∑‚£¶‚£Ñ‚£Ä‚£¥‚£ø‚£ß‚£Ä‚£Ä‚£¨‚£ø‚£ø‚£ø‚°∑‚†¢‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°ø‚†ø‚¢õ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
# ‚†ô‚¢ø‚£¶‚°Ä‚†à‚†õ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚†Ä‚¢∏‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢£‚°Ä‚†Ä‚†±‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚¢π‚£ø‚£∂‚£æ‚£ø‚°ø‚†ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£ø‚£ø‚†ô‚¢Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†±‚¢§‚£æ‚£ø‚£ø‚£ø‚†è‚†â‚†â‚¢â‚£Ω‚£ø‚£∂‚£§‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚£º‚£ø‚£ø‚£ø‚£ø‚°§‚†ö‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£á‚†Ä‚¢∏‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†â‚†â‚†Å‚†à‚†â‚†â‚†â‚†ô‚†ª‚£ø‚†ü‚¢¢‚°Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚¢∞‚°Å‚£ø‚£ø‚£ø‚£ø‚£ß‚°Ä‚£π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£æ‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢Ü‚†Ä‚†±‚°Ä‚†Ä
#‚†Ä‚†Ä‚¢∏‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ª‚£ø‚£ø‚£ø‚£ø‚£ø‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£∑‚£ø‚£ß‚†Ä
#‚†Ä‚†Ä‚¢ª‚¢∏‚£ø‚°ü‚¢ª‚£ø‚£ø‚†õ‚†õ‚†ø‚†õ‚¢π‚¢ø‚£ø‚°ø‚£ø‚£ø‚£ø‚£ø‚†ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚£ø‚†Ä
#‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚†æ‚†Å‚£ø‚£¶‚†Ä‚†Ä‚†Ä‚£á‚°∏‚†è‚†Ä‚£ø‚£ø‚£ø‚†ø‚†¢‚¢Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°Ä‚†§‚†Ä‚£§‚£∂‚£∂‚£∂‚£¶‚£§‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†õ‚†õ‚°è‚†Ä
#‚†Ä‚†Ä‚†Ä‚¢ø‚£ø‚£ø‚°Ü‚†Ä‚†ô‚†õ‚†Å‚†Ä‚£Ä‚†Ä‚†Ä‚¢Ä‚£º‚£ø‚†ü‚°Å‚†Ä‚†Ä‚†Ä‚†à‚†â‚†í‚†ä‚†°‚†§‚†§‚¢º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†∑‚£Ñ‚£Ä‚£∞‚£á‚£Ä‚°¥‚†Å‚†Ä
#‚†Ä‚†Ä‚†Ä‚†à‚†ª‚£ø‚£ø‚†Ä‚†Ç‚†§‚†§‚†§‚†§‚†ñ‚†ä‚£ø‚£ø‚£ø‚†ë‚†å‚£≥‚°Ü‚¢†‚£§‚†¥‚†ä‚†Å‚†â‚†â‚†â‚†í‚†¢‚¢ç‚°ª‚£ø‚°ü‚†Å‚†Ä‚†Ä‚†à‚¢ø‚£ø‚£ø‚†ü‚†Å‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ô‚†ì‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚†á‚†Ä‚†Ä‚†à‚¢≥‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚£ª‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚†Ø‚†§‚£Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ã‚¢†‚†û‚†Ä‚°Ä‚¢Ä‚°ú‚†Å‚†Ä‚†Ä‚†Ä‚†ë‚¢Ñ‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ñ‚†Ä‚£Ä‚¢Ä‚°¥‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°É‚¢¥‚°ø‚†Ä‚£Æ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†Ü
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†â‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ø‚£∂‚°è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†ú‚†Å‚†Ä‚†ö‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£¥‚°ä‚¢Å‚††‚†É‚¢Ä‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚°Ä‚†Ä‚°Ä‚†Ä‚†Ä‚†à‚†ë‚†¢‚°Ñ‚†Ä‚†Ä‚†Ä‚°º‚†â‚†â‚†â‚†ì‚†í‚†â‚†ò‚¢¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†î‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ß‚°û‚¢Å‚£¥‚£æ‚£ø‚£ø‚£∑‚£¶‚£Ä‚°§‚¢û‚°µ‚†í‚†ì‚¢í‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†â‚¢≤‚°¶‚†§‚†ö‚†Å‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚£∑‚£ø‚£ø‚£ø‚£ø‚†ü‚†õ‚†ø‚£ø‚°Ñ‚¢∏‚†Ä‚¢Ä‚£¥‚£ø‚£ø‚£ø‚£∑‚°§‚†ñ‚†ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ª‚£ø‚£ø‚£ø‚°á‚£¥‚£∂‚£Ü‚†ò‚°∑‚£à‚£∞‚£ø‚£ø‚£ø‚£ø‚°ø‚†ü‚†∑‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚†ø‚£Ø‚†£‚£õ‚£õ‚£Å‚£Ä‚°Ü‚†à‚†ª‚¢ø‚£ø‚£ø‚†è‚†Ä‚†Ä‚¢∞‚£∑‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢¶‚£Ä‚£•‚£¥‚£æ‚£ø‚†Ä‚†Ä‚†Ä‚†â‚†õ‚¢¶‚£Ñ‚£Ä‚£å‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚°õ‚†õ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚¢ª‚†ø‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
# –æ –±–æ–∂–µ, –∫–∞–∫–æ–π –∂–µ —Å–∞–Ω—à–∞–π–Ω –∞—Ö—É–µ–Ω–Ω—ã–π, –≤—Å–µ –º–∞–ª–æ–ª–µ—Ç–æ—á–∫–∏ —Å–∫–∞—á—É—Ç –Ω–∞ –µ–≥–æ –æ–≥—Ä–æ–º–Ω–æ–º —á–ª–µ–Ω–µ

# meta developer: @sunshinelzt

import io
import asyncio
import logging
from telethon import types, utils as telethon_utils
from .. import loader, utils

logger = logging.getLogger(__name__)

@loader.tds
class KeeperMod(loader.Module):
    """–ü–∏–∑–¥–µ—Ü –∫–∞–∫–æ–π —É–¥–æ–±–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å—è–∫–æ–π —Ö—É–π–Ω–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –Ω–∞—Ö—É–π"""
    strings = {"name": "Keeper"}
    
    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    DB_KEY = "Keeper"
    STATE_KEY = "state"
    MEDIA_FOLDER = "me"  # ID —á–∞—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ –ª–∏—á–∫–∞)
    
    # –ö—ç—à —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –¥–ª—è —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
    MIME_EXTENSIONS = {
        'image/jpeg': '.jpg',
        'image/png': '.png',
        'image/gif': '.gif',
        'image/webp': '.webp',
        'video/mp4': '.mp4',
        'video/quicktime': '.mov',
        'audio/mpeg': '.mp3',
        'audio/ogg': '.ogg',
        'application/pdf': '.pdf',
        'application/zip': '.zip',
        'application/x-rar-compressed': '.rar',
        'text/plain': '.txt'
    }
    
    # –≠–º–æ–¥–∑–∏
    EMOJI = {
        "saved": "<emoji document_id=6046410905829251121>üí•</emoji>",
        "toggle": "<emoji document_id=6044327262575141199>üåü</emoji>"
    }

    async def client_ready(self, client, db):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ"""
        self.client = client
        self.db = db
        self._me = await client.get_me()
        
        # –°–æ–∑–¥–∞–µ–º –∫—ç—à –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        self._media_cache = {}
        self._user_cache = {}
        
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ë–î
        if not self.db.get(self.DB_KEY, "initialized", False):
            # –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            self.db.set(self.DB_KEY, self.STATE_KEY, False)
            self.db.set(self.DB_KEY, "initialized", True)
            #logger.info("KeeperMod –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞—Ö—É–π!")

    def is_self_destruct(self, media):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–µ–µ—Å—è –≥–æ–≤–Ω–æ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)"""
        if not media:
            return False
            
        # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫—ç—à—É
        media_id = getattr(media, 'id', None)
        if media_id and media_id in self._media_cache:
            return self._media_cache[media_id]
            
        result = False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ TTL (—Ç–∞–π–º–µ—Ä —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è)
        if getattr(media, 'ttl_seconds', None) is not None:
            result = True
        # –§–ª–∞–≥ "–ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–¥–∏–Ω —Ä–∞–∑"
        elif getattr(media, 'has_view_once', False):
            result = True
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–∏—Ö—Å—è –º–µ–¥–∏–∞ –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º
        elif hasattr(media, 'document'):
            for attr in getattr(media.document, 'attributes', []):
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å —Ñ–ª–∞–≥–æ–º "–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ"
                if isinstance(attr, types.DocumentAttributeAudio) and attr.voice:
                    if getattr(media, 'has_view_once', False):
                        result = True
                        break
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–µ–æ —Å —Ñ–ª–∞–≥–æ–º "–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ"
                elif isinstance(attr, types.DocumentAttributeVideo):
                    if getattr(attr, 'round_message', False) and getattr(media, 'has_view_once', False):
                        result = True
                        break
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å ID
        if media_id:
            self._media_cache[media_id] = result
            
            # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏)
            if len(self._media_cache) > 1000:
                self._media_cache.clear()
                
        return result

    def get_extension(self, message):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —ç—Ç–æ–π –ø–∞—Ä–∞—à–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)"""
        if not message or not message.media:
            return ".—Ö–∑"
            
        # –ò–∑–≤–ª–µ–∫–∞–µ–º MIME-—Ç–∏–ø
        mime_type = getattr(message.media, 'mime_type', '')
        if not mime_type and hasattr(message.media, 'document'):
            mime_type = getattr(message.media.document, 'mime_type', '')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ MIME-—Ç–∏–ø—É –∏–∑ –∫—ç—à–∞
        if mime_type in self.MIME_EXTENSIONS:
            return self.MIME_EXTENSIONS[mime_type]
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å MIME-—Ç–∏–ø, –Ω–æ –Ω–µ—Ç –≤ –∫—ç—à–µ, –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –Ω–µ–≥–æ —Ç–∏–ø
        if mime_type:
            try:
                main_type, sub_type = mime_type.split('/', 1)
                return f".{sub_type}"
            except ValueError:
                pass
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if hasattr(message.media, 'document') and hasattr(message.media.document, 'attributes'):
            for attr in message.media.document.attributes:
                if isinstance(attr, types.DocumentAttributeFilename) and attr.file_name:
                    try:
                        return f".{attr.file_name.split('.')[-1]}"
                    except:
                        pass
        
        # –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ MIME-—Ç–∏–ø—É, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if mime_type:
            if "image" in mime_type:
                return ".jpg"
            elif "video" in mime_type:
                return ".mp4"
            elif "audio" in mime_type:
                return ".mp3"
        
        return ".—Ö–∑"  # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–æ—Å—å

    async def get_user_display_info(self, sender):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        if not sender:
            return None
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        sender_id = getattr(sender, 'id', 0)
        if sender_id in self._user_cache:
            return self._user_cache[sender_id]
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        first_name = getattr(sender, 'first_name', '–Ω–µ —É–∫–∞–∑–∞–Ω')
        last_name = getattr(sender, 'last_name', '')
        username = getattr(sender, 'username', '')
        
        display_name = f"{first_name}"
        if last_name:
            display_name += f" {last_name}"
            
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
        name_link = f"<a href='tg://user?id={sender_id}'>{display_name}</a>"
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç
        result = {
            "name_link": name_link,
            "username": username,
            "sender_id": sender_id
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        self._user_cache[sender_id] = result
        
        # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
        if len(self._user_cache) > 1000:
            self._user_cache.clear()
            
        return result

    def _make_caption(self, message, user_info):
        """–°–æ–∑–¥–∞—ë—Ç –ø–∏–∑–¥–∞—Ç—É—é –ø–æ–¥–ø–∏—Å—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        if not user_info:
            return f"{self.EMOJI['saved']} <b>–°–ø–∏–∑–¥–∏–ª –º–µ–¥–∏–∞ –æ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞</b>"
            
        caption = f"{self.EMOJI['saved']} <b>–°–ø–∏–∑–¥–∏–ª –º–µ–¥–∏–∞</b>\n"
        caption += f"<b>–û—Ç:</b> {user_info['name_link']}\n"
        
        if user_info['username']:
            caption += f"<b>–Æ–∑–µ—Ä–Ω–µ–π–º:</b> @{user_info['username']}\n"
            
        caption += f"<b>ID:</b> <code>{user_info['sender_id']}</code>"
        
        return caption

    async def save_media(self, message):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ç—É —Ö—É–π–Ω—é (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
            if not message or not message.media:
                return False
                
            # –°–∫–∞—á–∏–≤–∞–µ–º –º–µ–¥–∏–∞
            media_bytes = await message.download_media(bytes)
            if not media_bytes:
                logger.error("–•—É–π–Ω—è –∫–∞–∫–∞—è-—Ç–æ, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –º–µ–¥–∏–∞")
                return False
                
            # –°–æ–∑–¥–∞–µ–º BytesIO –æ–±—ä–µ–∫—Ç
            file = io.BytesIO(media_bytes)
            ext = self.get_extension(message)
            timestamp = utils.get_chat_id(message)
            file.name = getattr(message.file, "name", f"stolen_{timestamp}{ext}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            user_info = await self.get_user_display_info(message.sender)
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å—å
            caption = self._make_caption(message, user_info)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
            await self.client.send_file(
                self.MEDIA_FOLDER, 
                file, 
                caption=caption,
                reply_to=None,  # –ß—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–ª–æ, –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –ø—É—Å—Ç–æ–π
                silent=True  # –ë–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            )
            
            return True
        except Exception as e:
            logger.error(f"–ë–ª—è—Ç—å, –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: {e}")
            return False
    
    def _get_state(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"""
        return self.db.get(self.DB_KEY, self.STATE_KEY, False)

    def _set_state(self, state):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"""
        self.db.set(self.DB_KEY, self.STATE_KEY, state)
        return state

    def _toggle_state(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤–æ–µ"""
        current = self._get_state()
        return self._set_state(not current)

    @loader.owner
    async def kpcmd(self, m):
        """–ó–∞–±—Ä–∞—Ç—å –º–µ–¥–∏–∞ –ø–æ —Ä–µ–ø–ª–∞—é"""
        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
        reply = await m.get_reply_message()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞
        if not reply or not reply.media:
            await m.delete()
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –ª–∏ –æ–Ω–æ
        if not self.is_self_destruct(reply.media):
            await m.delete()
            return
        
        # –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É —Å—Ä–∞–∑—É
        await m.delete()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ–¥–∏–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        asyncio.create_task(self.save_media(reply))

    @loader.owner
    async def akpcmd(self, m):
        """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"""
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        new_state = self._toggle_state()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        if new_state:
            status_text = f"{self.EMOJI['toggle']} –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ <b>–≤–∫–ª—é—á–µ–Ω–æ</b>."
        else:
            status_text = f"{self.EMOJI['toggle']} –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ <b>–≤—ã–∫–ª—é—á–µ–Ω–æ</b>."
            
        # –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É
        await m.delete()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        temp_msg = await m.reply(status_text)
        
        # –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        await asyncio.sleep(2)
        await temp_msg.delete()

    async def watcher(self, m):
        """–°–º–æ—Ç—Ä–∏–º –∑–∞ –≤—Å–µ–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∫–∞–∫ –µ–±–∞–Ω—ã–µ —à–ø–∏–æ–Ω—ã"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ - —Å–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ –±—ã—Å—Ç—Ä—ã–µ
        if not m:
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        if not self._get_state():
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞
        if not m.media:
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—à–µ –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if m.sender_id == self._me.id:
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –ª–∏ –æ–Ω–æ
        if not self.is_self_destruct(m.media):
            return
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å watcher
        asyncio.create_task(self.save_media(m))
