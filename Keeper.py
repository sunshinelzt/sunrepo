__version__ = (1, 4, 8, 8)

#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚£∑‚£∂‚£§‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚¢†‚£§‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ª‚£ß‚†à‚†â‚†ª‚£∑‚£§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†π‚£ø‚°ü‚†ª‚¢∑‚£¶‚£Ñ‚£Ä‚£¥‚£ø‚£ß‚£Ä‚£Ä‚£¨‚£ø‚£ø‚£ø‚°∑‚†¢‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°ø‚†ø‚¢õ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
# ‚†ô‚¢ø‚£¶‚°Ä‚†à‚†õ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚†Ä‚¢∏‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢£‚°Ä‚†Ä‚†±‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚¢π‚£ø‚£∂‚£æ‚£ø‚°ø‚†ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£ø‚£ø‚†ô‚¢Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†±‚¢§‚£æ‚£ø‚£ø‚£ø‚†è‚†â‚†â‚¢â‚£Ω‚£ø‚£∂‚£§‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚£º‚£ø‚£ø‚£ø‚£ø‚°§‚†ö‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£á‚†Ä‚¢∏‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†â‚†â‚†Å‚†à‚†â‚†â‚†â‚†ô‚†ª‚£ø‚†ü‚¢¢‚°Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚¢∞‚°Å‚£ø‚£ø‚£ø‚£ø‚£ß‚°Ä‚£π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£æ‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢Ü‚†Ä‚†±‚°Ä‚†Ä
#‚†Ä‚†Ä‚¢∏‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ª‚£ø‚£ø‚£ø‚£ø‚£ø‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£∑‚£ø‚£ß‚†Ä
#‚†Ä‚†Ä‚¢ª‚¢∏‚£ø‚°ü‚¢ª‚£ø‚£ø‚†õ‚†õ‚†ø‚†õ‚¢π‚¢ø‚£ø‚°ø‚£ø‚£ø‚£ø‚£ø‚†ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚£ø‚†Ä
#‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚†æ‚†Å‚£ø‚£¶‚†Ä‚†Ä‚†Ä‚£á‚°∏‚†è‚†Ä‚£ø‚£ø‚£ø‚†ø‚†¢‚¢Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°Ä‚†§‚†Ä‚£§‚£∂‚£∂‚£∂‚£¶‚£§‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†õ‚†õ‚°è‚†Ä
#‚†Ä‚†Ä‚†Ä‚¢ø‚£ø‚£ø‚°Ü‚†Ä‚†ô‚†õ‚†Å‚†Ä‚£Ä‚†Ä‚†Ä‚¢Ä‚£º‚£ø‚†ü‚°Å‚†Ä‚†Ä‚†Ä‚†à‚†â‚†í‚†ä‚†°‚†§‚†§‚¢º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†∑‚£Ñ‚£Ä‚£∞‚£á‚£Ä‚°¥‚†Å‚†Ä
#‚†Ä‚†Ä‚†Ä‚†à‚†ª‚£ø‚£ø‚†Ä‚†Ç‚†§‚†§‚†§‚†§‚†ñ‚†ä‚£ø‚£ø‚£ø‚†ë‚†å‚£≥‚°Ü‚¢†‚£§‚†¥‚†ä‚†Å‚†â‚†â‚†â‚†í‚†¢‚¢ç‚°ª‚£ø‚°ü‚†Å‚†Ä‚†Ä‚†à‚¢ø‚£ø‚£ø‚†ü‚†Å‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ô‚†ì‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚†á‚†Ä‚†Ä‚†à‚¢≥‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚£ª‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚†Ø‚†§‚£Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ã‚¢†‚†û‚†Ä‚°Ä‚¢Ä‚°ú‚†Å‚†Ä‚†Ä‚†Ä‚†ë‚¢Ñ‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ñ‚†Ä‚£Ä‚¢Ä‚°¥‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°É‚¢¥‚°ø‚†Ä‚£Æ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†Ü
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†â‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ø‚£∂‚°è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†ú‚†Å‚†Ä‚†ö‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£¥‚°ä‚¢Å‚††‚†É‚¢Ä‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚°Ä‚†Ä‚°Ä‚†Ä‚†Ä‚†à‚†ë‚†¢‚°Ñ‚†Ä‚†Ä‚†Ä‚°º‚†â‚†â‚†â‚†ì‚†í‚†â‚†ò‚¢¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†î‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ß‚°û‚¢Å‚£¥‚£æ‚£ø‚£ø‚£∑‚£¶‚£Ä‚°§‚¢û‚°µ‚†í‚†ì‚¢í‚£¶‚°Ä‚†Ä‚†Ä‚†Ä‚†â‚¢≤‚°¶‚†§‚†ö‚†Å‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚£∑‚£ø‚£ø‚£ø‚£ø‚†ü‚†õ‚†ø‚£ø‚°Ñ‚¢∏‚†Ä‚¢Ä‚£¥‚£ø‚£ø‚£ø‚£∑‚°§‚†ñ‚†ä‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ª‚£ø‚£ø‚£ø‚°á‚£¥‚£∂‚£Ü‚†ò‚°∑‚£à‚£∞‚£ø‚£ø‚£ø‚£ø‚°ø‚†ü‚†∑‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚†ø‚£Ø‚†£‚£õ‚£õ‚£Å‚£Ä‚°Ü‚†à‚†ª‚¢ø‚£ø‚£ø‚†è‚†Ä‚†Ä‚¢∞‚£∑‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢¶‚£Ä‚£•‚£¥‚£æ‚£ø‚†Ä‚†Ä‚†Ä‚†â‚†õ‚¢¶‚£Ñ‚£Ä‚£å‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
#‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚°õ‚†õ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚¢ª‚†ø‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
# –æ –±–æ–∂–µ, –∫–∞–∫–æ–π –∂–µ —Å–∞–Ω—à–∞–π–Ω –∞—Ö—É–µ–Ω–Ω—ã–π, –≤—Å–µ –º–∞–ª–æ–ª–µ—Ç–æ—á–∫–∏ —Å–∫–∞—á—É—Ç –Ω–∞ –µ–≥–æ –æ–≥—Ä–æ–º–Ω–æ–º —á–ª–µ–Ω–µ

# meta developer: @sunshinelzt

import io
import asyncio
import logging
from telethon import types
from .. import loader, utils

logger = logging.getLogger(__name__)

@loader.tds
class KeeperMod(loader.Module):
    """–ü–∏–∑–¥–µ—Ü –∫–∞–∫–æ–π —É–¥–æ–±–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å—è–∫–æ–π —Ö—É–π–Ω–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –Ω–∞—Ö—É–π"""
    strings = {"name": "Keeper"}

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self._me = await client.get_me()
        self._silent_mode = True

    def is_self_destruct(self, media):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞—é—â–µ–µ—Å—è –≥–æ–≤–Ω–æ"""
        if not media:
            return False
        return getattr(media, 'ttl_seconds', None) is not None or getattr(media, 'has_view_once', False)

    def get_extension(self, message):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —ç—Ç–æ–π –ø–∞—Ä–∞—à–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é"""
        if not message or not message.media:
            return ".—Ö–∑"
            
        mime_type = getattr(message.media, 'mime_type', '')
        if not mime_type and hasattr(message.media, 'document'):
            mime_type = getattr(message.media.document, 'mime_type', '')
            
        extensions = {
            'image/jpeg': '.jpg',
            'image/png': '.png',
            'image/gif': '.gif',
            'video/mp4': '.mp4',
            'video/quicktime': '.mov',
            'audio/mpeg': '.mp3',
            'audio/ogg': '.ogg'
        }
        
        if mime_type in extensions:
            return extensions[mime_type]
        elif mime_type:
            main_type, sub_type = mime_type.split('/', 1)
            return f".{sub_type}"
        
        if hasattr(message.media, 'document') and hasattr(message.media.document, 'attributes'):
            for attr in message.media.document.attributes:
                if isinstance(attr, types.DocumentAttributeFilename) and attr.file_name:
                    return f".{attr.file_name.split('.')[-1]}"
        
        return ".jpg" if "image" in mime_type else ".mp4" if "video" in mime_type else ".—Ñ–∞–π–ª"

    async def save_media(self, message):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ç—É —Ö—É–π–Ω—é"""
        try:
            media_bytes = await message.download_media(bytes)
            if not media_bytes:
                return False
                
            file = io.BytesIO(media_bytes)
            ext = self.get_extension(message)
            timestamp = utils.get_chat_id(message)
            file.name = getattr(message.file, "name", f"stolen_{timestamp}{ext}")
            
            sender = message.sender
            caption = f"<emoji document_id=6046410905829251121>üí•</emoji> <b>–°–ø–∏–∑–¥–∏–ª–∏ –º–µ–¥–∏–∞</b>\n\n"
            if sender:
                caption += f"<b>–û—Ç:</b> {getattr(sender, 'first_name', '—Ö–∑ –∫—Ç–æ')} {getattr(sender, 'last_name', '')}\n"
                caption += f"<b>–Æ–∑–µ—Ä–Ω–µ–π–º:</b> @{getattr(sender, 'username', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')}\n"
                caption += f"<b>ID:</b> <code>{sender.id}</code>"
            
            await self.client.send_file("me", file, caption=caption)
            return True
        except Exception as e:
            logger.error(f"–ë–ª—è—Ç—å, –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: {e}")
            return False

    @loader.owner
    async def kpcmd(self, m):
        """–ó–∞–±—Ä–∞—Ç—å –º–µ–¥–∏–∞ –ø–æ —Ä–µ–ø–ª–∞—é"""
        reply = await m.get_reply_message()
        if not reply or not reply.media or not self.is_self_destruct(reply.media):
            return await m.delete()
        
        await m.delete()
        await self.save_media(reply)

    @loader.owner
    async def akpcmd(self, m):
        """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"""
        state = self.db.get("Keeper", "state", False)
        
        self.db.set("Keeper", "state", not state)
        
        if state:
            temp_msg = await m.reply("<emoji document_id=6044327262575141199>üåü</emoji> –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ <b>–≤—ã–∫–ª—é—á–µ–Ω–æ</b>.")
        else:
            temp_msg = await m.reply("<emoji document_id=6044327262575141199>üåü</emoji> –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ <b>–≤–∫–ª—é—á–µ–Ω–æ</b>.")
            
        await m.delete()
        await asyncio.sleep(2)
        await temp_msg.delete()

    async def watcher(self, m):
        """–°–º–æ—Ç—Ä–∏–º –∑–∞ –≤—Å–µ–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∫–∞–∫ –µ–±–∞–Ω—ã–µ —à–ø–∏–æ–Ω—ã"""
        if not m or not self.db.get("Keeper", "state", False):
            return
            
        if not m.media or not self.is_self_destruct(m.media):
            return
            
        if m.sender_id == self._me.id:
            return
            
        await self.save_media(m)
